<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LINE é ç´„ç³»çµ± - å…¨æ–‡æ¡ˆå¯ç·¨è¼¯ç‰ˆ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; height: 100vh; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .app-container { background-color: #ffffff; height: 100%; overflow-y: auto; display: flex; flex-direction: column; position: relative; }
        
        /* UI Styles */
        .tab-active { color: #06C755; font-weight: 700; }
        .tab-inactive { color: #9CA3AF; }
        
        .member-card-bg { background: linear-gradient(135deg, #1f2937 0%, #111827 100%); }
        .gold-text { color: #fbbf24; }
        
        .admin-input { border: 1px solid #e5e7eb; padding: 8px; rounded: 8px; width: 100%; font-size: 14px; transition: all 0.2s; }
        .admin-input:focus { outline: none; border-color: #06C755; box-shadow: 0 0 0 3px rgba(6, 199, 85, 0.1); }
        .admin-section { border-left: 4px solid #06C755; padding-left: 16px; margin-bottom: 24px; }
    </style>
</head>
<body>

    <div class="flex h-full max-w-7xl mx-auto shadow-2xl overflow-hidden rounded-none md:rounded-xl">
        
        <!-- ================= LEFT: CLIENT APP SIMULATOR ================= -->
        <div id="client-app" class="w-full md:w-[400px] md:border-r border-gray-200 flex-shrink-0 z-10 bg-white flex flex-col transition-all duration-300">
            
            <header id="app-header" class="bg-white sticky top-0 z-20 border-b border-gray-100 px-4 py-3 flex items-center justify-between shadow-sm flex-shrink-0 hidden">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-[#06C755] rounded-lg flex items-center justify-center text-white font-bold text-lg">L</div>
                    <h1 class="text-lg font-bold text-gray-800" id="app-title-display">LINE é ç´„</h1>
                </div>
                <button id="header-action-btn" class="text-sm text-[#06C755] font-bold hidden" onclick="openEditProfile()">ç·¨è¼¯</button>
            </header>

            <main id="app-content" class="flex-grow p-0 overflow-y-auto no-scrollbar relative bg-gray-50">
                <!-- Content Rendered via JS -->
            </main>

            <nav id="app-nav" class="bg-white border-t border-gray-100 absolute bottom-0 w-full h-16 flex justify-around items-center px-2 z-30 shadow-[0_-2px_10px_rgba(0,0,0,0.05)] hidden">
                <button onclick="navigateTo('home')" class="nav-item tab-inactive flex flex-col items-center space-y-1 w-1/4" data-target="home"><span class="text-2xl">ğŸ </span><span class="text-[10px]">é¦–é </span></button>
                <button onclick="navigateTo('services')" class="nav-item tab-inactive flex flex-col items-center space-y-1 w-1/4" data-target="services"><span class="text-2xl">ğŸ“…</span><span class="text-[10px]">é ç´„</span></button>
                <button onclick="navigateTo('records')" class="nav-item tab-inactive flex flex-col items-center space-y-1 w-1/4" data-target="records"><span class="text-2xl">ğŸ“‹</span><span class="text-[10px]">ç´€éŒ„</span></button>
                <button onclick="navigateTo('profile')" class="nav-item tab-active flex flex-col items-center space-y-1 w-1/4" data-target="profile"><span class="text-2xl">ğŸ‘¤</span><span class="text-[10px]">æœƒå“¡</span></button>
            </nav>
        </div>

        <!-- ================= RIGHT: ADMIN DASHBOARD (EDIT AREA) ================= -->
        <div id="admin-dashboard" class="hidden md:block flex-grow bg-gray-50 overflow-y-auto h-full p-6 md:p-8">
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-gray-50 z-20 py-2">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">âš™ï¸ åº—å®¶ç®¡ç†å¾Œå°</h2>
                    <p class="text-sm text-gray-500">æ‰€æœ‰æ–‡å­—ä¿®æ”¹å¾Œï¼Œå·¦å´ APP æœƒå³æ™‚æ›´æ–°ã€‚</p>
                </div>
                <div class="space-x-2">
                    <button onclick="resetToDefault()" class="text-red-500 text-sm hover:underline">é‡ç½®é è¨­</button>
                    <button onclick="logout()" class="text-blue-500 text-sm hover:underline">APPç™»å‡ºæ¸¬è©¦</button>
                </div>
            </div>

            <div class="space-y-8 max-w-3xl">
                
                <!-- 1. General Settings -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 admin-section">
                    <h3 class="font-bold text-lg mb-4 text-gray-800">ğŸª å•†åº—èˆ‡æ­¡è¿è³‡è¨Š</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-gray-500 mb-1">å•†åº—åç¨± (APP æ¨™é¡Œ)</label><input type="text" id="setting-shop-name" class="admin-input" oninput="updateSettings()"></div>
                        <div><label class="block text-xs font-bold text-gray-500 mb-1">é¦–é æ­¡è¿è©</label><input type="text" id="setting-welcome-msg" class="admin-input" oninput="updateSettings()"></div>
                    </div>
                </div>

                <!-- 2. Login Screen Text (NEW!) -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 admin-section">
                    <h3 class="font-bold text-lg mb-4 text-gray-800">ğŸ” ç™»å…¥ç•«é¢æ–‡æ¡ˆ</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-gray-500 mb-1">ç™»å…¥é ä¸»æ¨™é¡Œ</label><input type="text" id="setting-login-title" class="admin-input" oninput="updateSettings()"></div>
                        <div><label class="block text-xs font-bold text-gray-500 mb-1">ç™»å…¥é å‰¯æ¨™é¡Œ</label><input type="text" id="setting-login-subtitle" class="admin-input" oninput="updateSettings()"></div>
                    </div>
                </div>

                <!-- 3. Services Management -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 admin-section">
                    <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg text-gray-800">âœ‚ï¸ æœå‹™é …ç›®è¨­å®š</h3><button onclick="addNewService()" class="bg-[#06C755] text-white px-3 py-1 rounded-lg text-sm font-bold">+ æ–°å¢</button></div>
                    <div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-gray-50 text-gray-500"><tr><th class="p-2">åœ–ç¤º</th><th class="p-2">åç¨±</th><th class="p-2">åƒ¹æ ¼</th><th class="p-2 text-right">åˆªé™¤</th></tr></thead><tbody id="services-table-body"></tbody></table></div>
                </div>

                <!-- 4. Staff Management -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 admin-section">
                    <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg text-gray-800">ğŸ‘¨â€ğŸ¨ äººå“¡è¨­å®š</h3><button onclick="addNewStaff()" class="bg-blue-500 text-white px-3 py-1 rounded-lg text-sm font-bold">+ æ–°å¢</button></div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="staff-grid"></div>
                </div>
            </div>
        </div>
        
        <!-- Mobile Toggle Button -->
        <button id="mobile-back-btn" onclick="mobileToggleAdmin()" class="md:hidden hidden fixed bottom-20 right-4 bg-black text-white px-4 py-3 rounded-full shadow-xl z-50 text-sm font-bold flex items-center space-x-2">
            <span>âš™ï¸ å¾Œå°è¨­å®š</span>
        </button>
    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="hidden absolute inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-scale-in">
            <h3 class="text-xl font-bold mb-4">ä¿®æ”¹æœƒå“¡è³‡æ–™</h3>
            <div class="space-y-4">
                <div><label class="text-xs text-gray-500">é¡¯ç¤ºåç¨±</label><input id="edit-name" type="text" class="w-full border p-2 rounded-lg focus:ring-2 focus:ring-[#06C755] outline-none"></div>
                <div><label class="text-xs text-gray-500">è¯çµ¡é›»è©±</label><input id="edit-phone" type="tel" class="w-full border p-2 rounded-lg focus:ring-2 focus:ring-[#06C755] outline-none"></div>
                <div class="flex space-x-2 pt-2"><button onclick="closeEditProfile()" class="flex-1 py-2 text-gray-500 bg-gray-100 rounded-lg">å–æ¶ˆ</button><button onclick="saveProfile()" class="flex-1 py-2 text-white bg-[#06C755] rounded-lg font-bold">å„²å­˜</button></div>
            </div>
        </div>
    </div>

    <!-- Coupon Modal -->
    <div id="coupon-modal" class="hidden absolute inset-0 z-50 bg-black bg-opacity-50 flex items-end justify-center sm:items-center">
        <div class="bg-gray-100 w-full md:max-w-sm h-[70%] md:h-auto md:rounded-2xl rounded-t-2xl p-4 shadow-2xl animate-scale-in flex flex-col">
            <div class="flex justify-between items-center mb-4 px-2"><h3 class="text-lg font-bold">æˆ‘çš„å„ªæƒ åˆ¸</h3><button onclick="closeCouponModal()" class="w-8 h-8 bg-gray-200 rounded-full text-gray-500">Ã—</button></div>
            <div class="flex-grow overflow-y-auto space-y-3 p-2">
                <div class="bg-white p-4 rounded-lg shadow-sm flex items-center relative overflow-hidden"><div class="border-r-2 border-dashed border-gray-200 pr-4 mr-4"><span class="text-2xl font-bold text-red-500">85æŠ˜</span></div><div><div class="font-bold text-gray-800">æ–°æœƒå“¡è¦‹é¢ç¦®</div><div class="text-xs text-gray-400">æ•ˆæœŸè‡³: 2025/12/31</div></div><button class="absolute right-4 bg-red-50 text-red-500 text-xs px-2 py-1 rounded">æœªä½¿ç”¨</button></div>
            </div>
        </div>
    </div>

    <!-- ================= JAVASCRIPT LOGIC ================= -->
    <script>
        // --- 1. DATA & STATE ---
        const DEFAULTS = {
            shopName: "LINE é ç´„ç³»çµ±",
            welcomeMsg: "æ­¡è¿å›ä¾†ï¼Œè«‹é¸æ“‡æ‚¨éœ€è¦çš„æœå‹™ã€‚",
            loginTitle: "æœƒå“¡ç™»å…¥",
            loginSubtitle: "è«‹é¸æ“‡ç™»å…¥æ–¹å¼ä»¥é–‹å§‹é ç´„",
            services: [
                { id: 's1', name: 'ç²¾ç·»å‰ªé«®', price: 600, duration: 60, icon: 'âœ‚ï¸' },
                { id: 's2', name: 'æŸ“é«®è¨­è¨ˆ', price: 2500, duration: 120, icon: 'ğŸ¨' }
            ],
            staff: [{ id: 'st1', name: 'Alice', image: 'ğŸ‘©â€ğŸ¦°' }, { id: 'st2', name: 'Bob', image: 'ğŸ‘¨â€ğŸ¦±' }]
        };

        let store = { config: {}, user: null, bookings: [] };
        let currentState = { view: 'login', booking: {} };
        let verificationCode = ""; 

        // --- 2. INITIALIZATION ---
        function loadData() {
            const savedConfig = localStorage.getItem('booking_app_config');
            store.config = savedConfig ? JSON.parse(savedConfig) : JSON.parse(JSON.stringify(DEFAULTS));
            
            // Populate Admin Inputs
            document.getElementById('setting-shop-name').value = store.config.shopName;
            document.getElementById('setting-welcome-msg').value = store.config.welcomeMsg;
            document.getElementById('setting-login-title').value = store.config.loginTitle || DEFAULTS.loginTitle;
            document.getElementById('setting-login-subtitle').value = store.config.loginSubtitle || DEFAULTS.loginSubtitle;
            
            renderAdminLists();

            // Check Login Status
            const savedUser = localStorage.getItem('booking_app_user');
            if (savedUser) {
                store.user = JSON.parse(savedUser);
                navigateTo('profile'); // Default to profile on return
            } else {
                navigateTo('login');
            }
        }
        function saveData() {
            localStorage.setItem('booking_app_config', JSON.stringify(store.config));
            
            // Real-time Update for specific elements if they exist
            const titleEl = document.getElementById('app-title-display');
            if(titleEl) titleEl.innerText = store.config.shopName;
            
            // Re-render current view to reflect text changes
            if (currentState.view === 'login') renderView('login');
            else if (currentState.view === 'home') renderView('home');
        }

        // --- 3. LOGIN LOGIC ---
        function renderLogin() {
            document.getElementById('app-header').classList.add('hidden');
            document.getElementById('app-nav').classList.add('hidden');
            
            // Use Configurable Text
            const title = store.config.loginTitle || DEFAULTS.loginTitle;
            const sub = store.config.loginSubtitle || DEFAULTS.loginSubtitle;

            return `
                <div class="h-full flex flex-col items-center justify-center p-8 bg-white animate-fade-in relative">
                    <div class="w-full max-w-sm">
                        <div class="text-center mb-8">
                            <div class="w-20 h-20 bg-[#06C755] rounded-3xl flex items-center justify-center text-white text-4xl font-bold mx-auto mb-6 shadow-xl shadow-green-100">L</div>
                            <h2 class="text-2xl font-bold text-gray-800">${title}</h2>
                            <p class="text-gray-400 mt-2 text-sm">${sub}</p>
                        </div>
                        
                        <button onclick="lineLoginMock()" class="w-full bg-[#06C755] text-white py-4 rounded-2xl font-bold text-lg shadow-lg hover:bg-[#05b54d] transition transform active:scale-95 flex items-center justify-center space-x-3 mb-6 relative overflow-hidden group">
                            <span class="text-2xl font-bold">LINE</span>
                            <span>ä½¿ç”¨ LINE å¸³è™Ÿç™»å…¥</span>
                        </button>

                        <div class="relative my-6">
                            <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-100"></div></div>
                            <div class="relative flex justify-center text-xs text-gray-400"><span class="px-2 bg-white">æˆ–ä½¿ç”¨æ‰‹æ©Ÿè™Ÿç¢¼é©—è­‰</span></div>
                        </div>

                        <div id="phone-login-step-1" class="space-y-4">
                            <input type="tel" id="login-phone" class="w-full bg-gray-50 border border-gray-100 rounded-2xl px-5 py-3 text-lg focus:ring-2 focus:ring-[#06C755] focus:outline-none transition" placeholder="è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼">
                            <button onclick="sendSmsCode()" class="w-full bg-white border border-gray-200 text-gray-700 py-3 rounded-2xl font-bold shadow-sm hover:bg-gray-50 transition">ç™¼é€é©—è­‰ç¢¼</button>
                        </div>

                        <div id="phone-login-step-2" class="space-y-4 hidden animate-fade-in">
                            <input type="number" id="login-code" class="w-full bg-gray-50 border border-gray-100 rounded-2xl px-5 py-3 text-lg text-center tracking-[1em] font-bold focus:ring-2 focus:ring-[#06C755] focus:outline-none" placeholder="----">
                            <p class="text-center text-sm text-gray-400">é©—è­‰ç¢¼: <span id="mock-code-display" class="font-bold text-[#06C755]"></span></p>
                            <button onclick="verifyAndLogin()" class="w-full bg-gray-800 text-white py-3 rounded-2xl font-bold shadow-lg hover:bg-gray-700 transition">é©—è­‰ä¸¦ç™»å…¥</button>
                            <button onclick="resetLoginStep()" class="w-full text-gray-400 text-sm py-2">é‡æ–°è¼¸å…¥</button>
                        </div>

                        <div class="mt-6">
                             <button onclick="googleLoginMock()" class="w-full border border-gray-200 py-3 rounded-xl flex items-center justify-center space-x-3 hover:bg-gray-50 transition text-sm">
                                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-4 h-4">
                                <span class="text-gray-600 font-medium">Google ç™»å…¥</span>
                            </button>
                        </div>
                    </div>
                </div>`;
        }
        function lineLoginMock() { setTimeout(() => loginSuccess({ userId: 'line_'+Date.now(), displayName: 'LINE ç”¨æˆ¶', phone: '', loginType: 'line', points: 100 }), 1000); }
        function sendSmsCode() {
            const phone = document.getElementById('login-phone').value;
            if (!phone || phone.length < 8) return alert('è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼');
            verificationCode = Math.floor(1000 + Math.random() * 9000).toString();
            document.getElementById('phone-login-step-1').classList.add('hidden');
            document.getElementById('phone-login-step-2').classList.remove('hidden');
            document.getElementById('mock-code-display').innerText = verificationCode;
            setTimeout(() => document.getElementById('login-code').value = verificationCode, 800);
        }
        function resetLoginStep() { document.getElementById('phone-login-step-2').classList.add('hidden'); document.getElementById('phone-login-step-1').classList.remove('hidden'); }
        function verifyAndLogin() {
            if (document.getElementById('login-code').value === verificationCode) {
                const phone = document.getElementById('login-phone').value;
                loginSuccess({ userId: 'u_'+phone, displayName: 'æœƒå“¡ '+phone.slice(-4), phone: phone, loginType: 'phone', points: 100 });
            } else alert('é©—è­‰ç¢¼éŒ¯èª¤');
        }
        function googleLoginMock() { setTimeout(() => loginSuccess({ userId: 'g_'+Date.now(), displayName: 'Google ç”¨æˆ¶', phone: '', loginType: 'google', points: 100 }), 1000); }
        function loginSuccess(userData) {
            store.user = userData;
            localStorage.setItem('booking_app_user', JSON.stringify(store.user));
            document.getElementById('app-content').innerHTML = `<div class="h-full flex flex-col items-center justify-center bg-white animate-scale-in"><div class="text-5xl mb-4">ğŸ‰</div><h2 class="text-xl font-bold">æ­¡è¿åŠ å…¥æœƒå“¡</h2><p class="text-gray-400 text-sm mt-2">æ­£åœ¨å‰å¾€æœƒå“¡ä¸­å¿ƒ...</p></div>`;
            setTimeout(() => navigateTo('profile'), 1500);
        }

        // --- 4. NAVIGATION & VIEWS ---
        function navigateTo(view) {
            currentState.view = view;
            if (view === 'login') { renderView('login'); return; }
            document.getElementById('app-header').classList.remove('hidden');
            document.getElementById('app-nav').classList.remove('hidden');
            const headerBtn = document.getElementById('header-action-btn');
            if(view === 'profile') headerBtn.classList.remove('hidden'); else headerBtn.classList.add('hidden');
            document.querySelectorAll('.nav-item').forEach(el => {
                const active = el.dataset.target === view || (['services','staff','time','confirm','success'].includes(view) && el.dataset.target === 'services');
                el.className = `nav-item flex flex-col items-center space-y-1 w-1/4 ${active ? 'tab-active' : 'tab-inactive'}`;
            });
            renderView(view);
        }

        function renderView(view) {
            const content = document.getElementById('app-content');
            content.innerHTML = '';
            document.getElementById('app-title-display').innerText = view === 'profile' ? 'æœƒå“¡ä¸­å¿ƒ' : store.config.shopName;
            
            if (view === 'login') content.innerHTML = renderLogin();
            else if (view === 'home') content.innerHTML = renderHome();
            else if (view === 'profile') content.innerHTML = renderProfile();
            else if (view === 'services') content.innerHTML = renderServices();
            else if (view === 'staff') content.innerHTML = renderStaff();
            else if (view === 'time') { content.innerHTML = renderTimeSelection(); setTimeout(initCalendar, 0); }
            else if (view === 'confirm') content.innerHTML = renderConfirmation();
            else if (view === 'success') content.innerHTML = renderSuccess();
            else if (view === 'records') content.innerHTML = renderRecords();
        }

        // --- VIEWS ---
        function renderProfile() {
            const u = store.user;
            let icon = 'ğŸ“±'; if (u.loginType === 'line') icon = '<span class="text-[#06C755] font-bold">LINE</span>'; else if (u.loginType === 'google') icon = '<span class="text-red-500 font-bold">G</span>';
            return `
                <div class="space-y-4 animate-fade-in pb-6">
                    <div class="px-4 pt-4">
                        <div class="member-card-bg rounded-2xl p-6 text-white shadow-xl relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl">ğŸ’</div>
                            <div class="flex items-center space-x-4 mb-6">
                                <div class="w-14 h-14 bg-white rounded-full flex items-center justify-center text-xl shadow-lg">${icon}</div>
                                <div><h2 class="text-lg font-bold">${u.displayName}</h2><p class="text-xs text-gray-300">${u.phone || 'å°šæœªç¶å®šé›»è©±'}</p></div>
                                <div class="ml-auto bg-yellow-500 text-black text-[10px] font-bold px-2 py-1 rounded-full">GOLD</div>
                            </div>
                            <div class="flex justify-between items-end">
                                <div><p class="text-[10px] text-gray-400 mb-1">æœƒå“¡ç·¨è™Ÿ</p><p class="font-mono text-sm tracking-widest opacity-80">8829 1023 9928</p></div>
                                <div class="text-right"><p class="text-[10px] text-gray-400">ç¾æœ‰é»æ•¸</p><p class="text-2xl font-bold gold-text">${u.points || 0}</p></div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 px-4">
                        <div class="bg-white p-3 rounded-xl shadow-sm text-center"><div class="text-[#06C755] font-bold text-lg">${u.points || 0}</div><div class="text-xs text-gray-500">é»æ•¸</div></div>
                        <div onclick="openCouponModal()" class="bg-white p-3 rounded-xl shadow-sm text-center cursor-pointer hover:bg-gray-50"><div class="text-red-500 font-bold text-lg">2</div><div class="text-xs text-gray-500">å„ªæƒ åˆ¸</div></div>
                        <div class="bg-white p-3 rounded-xl shadow-sm text-center"><div class="text-gray-800 font-bold text-lg">$0</div><div class="text-xs text-gray-500">å„²å€¼é‡‘</div></div>
                    </div>
                    <div class="bg-white mx-4 rounded-xl shadow-sm overflow-hidden">
                        <div onclick="openEditProfile()" class="flex items-center justify-between p-4 border-b border-gray-50 cursor-pointer hover:bg-gray-50"><div class="flex items-center space-x-3"><span class="text-xl">âœï¸</span><span class="text-sm font-medium text-gray-700">ä¿®æ”¹å€‹äººè³‡æ–™</span></div><span class="text-gray-300">â€º</span></div>
                        <div onclick="navigateTo('records')" class="flex items-center justify-between p-4 border-b border-gray-50 cursor-pointer hover:bg-gray-50"><div class="flex items-center space-x-3"><span class="text-xl">ğŸ“…</span><span class="text-sm font-medium text-gray-700">é ç´„ç´€éŒ„æŸ¥è©¢</span></div><span class="text-gray-300">â€º</span></div>
                        <div onclick="openCouponModal()" class="flex items-center justify-between p-4 border-b border-gray-50 cursor-pointer hover:bg-gray-50"><div class="flex items-center space-x-3"><span class="text-xl">ğŸŸï¸</span><span class="text-sm font-medium text-gray-700">æˆ‘çš„å„ªæƒ åˆ¸</span></div><span class="text-gray-300">â€º</span></div>
                         <div class="flex items-center justify-between p-4 cursor-pointer hover:bg-gray-50"><div class="flex items-center space-x-3"><span class="text-xl">ğŸ’¬</span><span class="text-sm font-medium text-gray-700">è¯çµ¡å®¢æœ</span></div><span class="text-gray-300">â€º</span></div>
                    </div>
                    <div class="px-4"><button onclick="logout()" class="w-full bg-white text-red-500 py-3 rounded-xl text-sm font-bold shadow-sm border border-red-50 hover:bg-red-50 transition">ç™»å‡ºæœƒå“¡</button></div>
                </div>`;
        }
        function renderHome() {
            return `
                <div class="space-y-6 animate-fade-in p-4">
                    <div class="w-full h-40 bg-gradient-to-r from-gray-800 to-gray-900 rounded-2xl flex items-center p-6 text-white relative overflow-hidden shadow-lg">
                        <div class="z-10"><h2 class="text-xl font-bold">Hi, ${store.user.displayName}</h2><p class="text-xs opacity-70 mt-1">${store.config.welcomeMsg}</p><button onclick="navigateTo('services')" class="mt-4 bg-[#06C755] text-white px-4 py-2 rounded-full text-sm font-bold shadow-md hover:scale-105 transition-transform">ç«‹å³é ç´„</button></div>
                        <div class="absolute right-4 bottom-4 text-6xl opacity-20">âœ‚ï¸</div>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 mb-3">ç†±é–€æœå‹™</h3>
                        <div class="grid grid-cols-2 gap-4">
                            ${store.config.services.slice(0, 4).map(s => `
                                <div onclick="selectService('${s.id}')" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center cursor-pointer hover:border-[#06C755] transition">
                                    <span class="text-3xl mb-2">${s.icon}</span><span class="font-bold text-gray-700 text-sm">${s.name}</span><span class="text-xs text-gray-400">$${s.price}</span>
                                </div>`).join('')}
                        </div>
                    </div>
                </div>`;
        }
        function renderServices() { return `<div class="space-y-3 animate-fade-in p-4"><div class="flex items-center space-x-2 mb-2"><button onclick="navigateTo('home')">â€¹</button><h2 class="font-bold">é¸æ“‡æœå‹™</h2></div>${store.config.services.map(s => `<div onclick="selectService('${s.id}')" class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between cursor-pointer hover:border-[#06C755] hover:bg-green-50 transition"><div class="flex items-center space-x-3"><div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-xl">${s.icon}</div><div><div class="font-bold text-gray-800">${s.name}</div><div class="text-xs text-gray-500">${s.duration} åˆ†é˜</div></div></div><div class="font-bold text-[#06C755]">NT$ ${s.price}</div></div>`).join('')}</div>`; }
        function renderStaff() { return `<div class="space-y-3 animate-fade-in p-4"><div class="flex items-center space-x-2 mb-2"><button onclick="navigateTo('services')">â€¹</button><h2 class="font-bold">é¸æ“‡è¨­è¨ˆå¸«</h2></div><div class="grid grid-cols-2 gap-3">${store.config.staff.map(s => `<div onclick="selectStaff('${s.id}')" class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm text-center cursor-pointer hover:border-[#06C755] hover:bg-green-50 transition group"><div class="text-4xl mb-2 transition transform group-hover:scale-110">${s.image}</div><div class="font-bold text-gray-800">${s.name}</div></div>`).join('')}</div></div>`; }
        function renderConfirmation() { const f = currentState.booking; return `<div class="space-y-4 animate-fade-in p-4"><div class="flex items-center space-x-2 mb-2"><button onclick="navigateTo('time')">â€¹</button><h2 class="font-bold">ç¢ºèªé ç´„</h2></div><div class="bg-white p-5 rounded-xl border-t-4 border-[#06C755] shadow-lg space-y-3"><div class="flex justify-between border-b border-gray-50 pb-2"><span class="text-gray-500">æœå‹™</span><span class="font-bold text-lg">${f.service.name}</span></div><div class="flex justify-between border-b border-gray-50 pb-2"><span class="text-gray-500">è¨­è¨ˆå¸«</span><span class="font-bold">${f.staff.name}</span></div><div class="flex justify-between border-b border-gray-50 pb-2"><span class="text-gray-500">æ™‚é–“</span><span class="font-bold text-[#06C755]">${f.date} ${f.time}</span></div><div class="flex justify-between pt-2"><span class="text-gray-500">è²»ç”¨</span><span class="font-bold text-xl">NT$ ${f.service.price}</span></div></div><div class="space-y-2"><label class="text-xs font-bold text-gray-500 ml-1">å§“å</label><input id="userNameInput" type="text" class="w-full p-3 border rounded-xl bg-white" placeholder="é ç´„å§“å" value="${store.user.displayName || ''}"></div><div class="space-y-2"><label class="text-xs font-bold text-gray-500 ml-1">é›»è©±</label><input id="userPhoneInput" type="tel" class="w-full p-3 border rounded-xl bg-white" placeholder="è¯çµ¡é›»è©±" value="${store.user.phone || ''}"></div><button onclick="submitBooking()" class="w-full bg-[#06C755] text-white py-3 rounded-xl font-bold shadow-lg hover:bg-[#05b54d] active:scale-95 transition">ç¢ºèªé€å‡º</button></div>`; }
        function renderSuccess() { return `<div class="flex flex-col items-center justify-center h-full p-6 text-center animate-scale-in"><div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center text-4xl mb-4 text-[#06C755]">âœ“</div><h2 class="text-2xl font-bold mb-2 text-gray-800">é ç´„æˆåŠŸï¼</h2><p class="text-gray-500 text-sm mb-6">æ„Ÿè¬æ‚¨çš„é ç´„ã€‚</p><button onclick="navigateTo('records')" class="w-full bg-gray-100 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-200">æŸ¥çœ‹ç´€éŒ„</button></div>`; }
        function renderRecords() { const list = store.bookings.slice().reverse(); return `<div class="space-y-3 animate-fade-in p-4"><h2 class="font-bold text-xl mb-4">é ç´„ç´€éŒ„</h2>${list.length === 0 ? '<div class="text-gray-400 text-center mt-10 text-sm">å°šç„¡ç´€éŒ„</div>' : ''}${list.map(b => `<div class="bg-white p-4 rounded-xl border-l-4 border-[#06C755] shadow-sm"><div class="font-bold text-lg">${b.service.name}</div><div class="text-sm text-gray-500 mt-1">è¨­è¨ˆå¸«: ${b.staff.name}</div><div class="mt-3 flex justify-between text-sm items-center pt-2 border-t border-gray-50"><span class="text-gray-600">ğŸ“… ${b.date} ${b.time}</span><span class="font-bold text-white bg-[#06C755] px-2 py-0.5 rounded text-xs">å·²é ç´„</span></div></div>`).join('')}</div>`; }
        function renderTimeSelection() { return `<div class="h-full flex flex-col animate-fade-in p-4"><div class="flex items-center space-x-2 mb-2"><button onclick="navigateTo('staff')">â€¹</button><h2 class="font-bold">é¸æ“‡æ™‚é–“</h2></div><div class="bg-white p-4 rounded-xl border border-gray-100 mb-4 shadow-sm"><div id="calendarGrid" class="grid grid-cols-7 gap-1 text-center text-sm"></div></div><div id="timeSlots" class="grid grid-cols-3 gap-2 overflow-y-auto content-start"></div></div>`; }

        // --- HELPERS & ADMIN ---
        function selectService(id) { currentState.booking.service = store.config.services.find(s => s.id === id); navigateTo('staff'); }
        function selectStaff(id) { currentState.booking.staff = store.config.staff.find(s => s.id === id); navigateTo('time'); }
        function initCalendar() {
            const grid = document.getElementById('calendarGrid');
            if(!grid) return;
            grid.innerHTML = '';
            ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(d => grid.innerHTML += `<div class="text-gray-400 text-xs mb-1">${d}</div>`);
            for(let i=0; i<3; i++) grid.innerHTML += `<div></div>`;
            for(let i=1; i<=30; i++) {
                grid.innerHTML += `<div onclick="selectDate(${i})" class="calendar-day hover:bg-green-50 w-8 h-8 flex items-center justify-center rounded-full cursor-pointer mx-auto text-sm" id="day-${i}">${i}</div>`;
            }
        }
        function selectDate(d) {
            document.querySelectorAll('.calendar-day').forEach(el => el.classList.remove('selected'));
            document.getElementById(`day-${d}`).classList.add('selected');
            currentState.booking.date = `2026-01-${d}`;
            const times = ['10:00', '11:00', '13:00', '14:30', '16:00', '19:00'];
            document.getElementById('timeSlots').innerHTML = times.map(t => `<button onclick="selectTime('${t}')" class="border border-gray-200 p-2 rounded-lg text-sm hover:border-[#06C755] hover:text-[#06C755] hover:bg-green-50 transition">${t}</button>`).join('');
        }
        function selectTime(t) { currentState.booking.time = t; navigateTo('confirm'); }
        function submitBooking() { store.bookings.push({ ...currentState.booking, id: Date.now() }); navigateTo('success'); }
        
        function mobileToggleAdmin() {
            const dash = document.getElementById('admin-dashboard');
            const client = document.getElementById('client-app');
            const btn = document.getElementById('mobile-back-btn');
            dash.classList.toggle('hidden'); client.classList.toggle('hidden'); btn.classList.toggle('hidden');
        }
        
        function updateSettings() {
            store.config.shopName = document.getElementById('setting-shop-name').value;
            store.config.welcomeMsg = document.getElementById('setting-welcome-msg').value;
            store.config.loginTitle = document.getElementById('setting-login-title').value;
            store.config.loginSubtitle = document.getElementById('setting-login-subtitle').value;
            saveData();
        }
        
        function renderAdminLists() {
            const tbody = document.getElementById('services-table-body');
            tbody.innerHTML = store.config.services.map((s, index) => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="p-2"><input type="text" class="w-10 text-center border rounded" value="${s.icon}" oninput="editService(${index}, 'icon', this.value)"></td>
                    <td class="p-2"><input type="text" class="w-full border rounded px-2 py-1" value="${s.name}" oninput="editService(${index}, 'name', this.value)"></td>
                    <td class="p-2"><input type="number" class="w-20 border rounded px-2 py-1" value="${s.price}" oninput="editService(${index}, 'price', this.value)"></td>
                    <td class="p-2 text-right"><button onclick="deleteService(${index})" class="text-red-500 font-bold">Ã—</button></td>
                </tr>`).join('');
            const staffGrid = document.getElementById('staff-grid');
            staffGrid.innerHTML = store.config.staff.map((s, index) => `
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 relative group text-center">
                    <button onclick="deleteStaff(${index})" class="absolute top-1 right-2 text-gray-300 hover:text-red-500">Ã—</button>
                    <input type="text" class="w-10 h-10 text-2xl text-center bg-white rounded-full border mb-1" value="${s.image}" oninput="editStaff(${index}, 'image', this.value)">
                    <input type="text" class="w-full text-center text-sm font-bold bg-transparent border-b border-transparent focus:border-[#06C755] focus:outline-none" value="${s.name}" oninput="editStaff(${index}, 'name', this.value)">
                </div>`).join('');
        }
        function addNewService() { store.config.services.push({ id: 's'+Date.now(), name: 'æ–°æœå‹™', price: 1000, duration: 60, icon: 'ğŸ†•' }); saveData(); renderAdminLists(); }
        function editService(i, f, v) { if(f==='price') v=parseInt(v); store.config.services[i][f] = v; saveData(); }
        function deleteService(i) { if(confirm('åˆªé™¤?')) { store.config.services.splice(i, 1); saveData(); renderAdminLists(); } }
        function addNewStaff() { store.config.staff.push({ id: 'st'+Date.now(), name: 'æ–°äººå“¡', image: 'ğŸ‘¤' }); saveData(); renderAdminLists(); }
        function editStaff(i, f, v) { store.config.staff[i][f] = v; saveData(); }
        function deleteStaff(i) { if(confirm('åˆªé™¤?')) { store.config.staff.splice(i, 1); saveData(); renderAdminLists(); } }
        function resetToDefault() { if(confirm('é‡ç½®?')) { localStorage.removeItem('booking_app_config'); loadData(); } }
        function logout() { if(confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) { localStorage.removeItem('booking_app_user'); store.user = null; navigateTo('login'); } }
        
        function openEditProfile() { document.getElementById('edit-name').value = store.user.displayName; document.getElementById('edit-phone').value = store.user.phone || ''; document.getElementById('edit-profile-modal').classList.remove('hidden'); }
        function closeEditProfile() { document.getElementById('edit-profile-modal').classList.add('hidden'); }
        function saveProfile() { const newName = document.getElementById('edit-name').value; const newPhone = document.getElementById('edit-phone').value; if(newName) { store.user.displayName = newName; store.user.phone = newPhone; localStorage.setItem('booking_app_user', JSON.stringify(store.user)); closeEditProfile(); renderView('profile'); } }
        function openCouponModal() { document.getElementById('coupon-modal').classList.remove('hidden'); }
        function closeCouponModal() { document.getElementById('coupon-modal').classList.add('hidden'); }

        window.onload = loadData;
        const style = document.createElement('style');
        style.innerHTML = `.animate-fade-in { animation: fadeIn 0.4s ease-out forwards; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } } .animate-scale-in { animation: scaleIn 0.3s ease-out forwards; } @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }`;
        document.head.appendChild(style);

    </script>
</body>
</html>