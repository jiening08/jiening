<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LINE é ç´„ç³»çµ± - æ¥µé€Ÿç‰ˆ</title>
    
    <!-- 1. å°‡ JS ç§»åˆ°åº•éƒ¨ï¼Œé€™è£¡åªæ”¾é—œéµ CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6; 
            height: 100vh;
            overflow: hidden;
        }

        /* éš±è—æ»¾å‹•æ¢ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .app-container {
            background-color: #ffffff;
            height: 100%;
            overflow-y: auto;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* UI å…ƒä»¶æ¨£å¼ */
        .tab-active { color: #06C755; font-weight: 700; }
        .tab-inactive { color: #9CA3AF; }
        
        .calendar-day {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            cursor: pointer; border-radius: 50%; transition: all 0.2s;
        }
        .calendar-day.selected { background-color: #06C755; color: white; }

        /* æ–°å¢ï¼šéé˜»æ“‹å¼é€£ç·šæç¤º (Toast) */
        .connection-toast {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0;
            pointer-events: none; /* è®“é»æ“Šç©¿é€ï¼Œä¸å½±éŸ¿æ“ä½œ */
        }
        .connection-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .connection-toast.hidden-toast {
            opacity: 0;
            transform: translateX(-50%) translateY(-20px);
        }

        /* è¼‰å…¥å‹•ç•«å°åœˆåœˆ */
        .spinner {
            width: 12px;
            height: 12px;
            border: 2px solid #ffffff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- 2. é€£ç·šç‹€æ…‹æç¤º (ä¸å†æ˜¯å…¨è¢å¹•é®ç½©) -->
    <div id="liff-toast" class="connection-toast show">
        <div class="spinner"></div>
        <span>æ­£åœ¨é€£æ¥ LINE å¸³è™Ÿ...</span>
    </div>

    <div class="flex h-full max-w-7xl mx-auto shadow-2xl overflow-hidden rounded-none md:rounded-xl">
        
        <!-- Client App -->
        <div id="client-app" class="w-full md:w-[450px] md:border-r border-gray-200 flex-shrink-0 z-10">
            <div class="app-container no-scrollbar">
                <header class="bg-white sticky top-0 z-20 border-b border-gray-100 px-4 py-3 flex items-center justify-between shadow-sm">
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-[#06C755] rounded-lg flex items-center justify-center text-white font-bold text-lg">L</div>
                        <h1 class="text-lg font-bold text-gray-800">LINE é ç´„</h1>
                    </div>
                    <!-- Status Display -->
                    <div id="user-status-badge" class="text-[10px] bg-gray-100 px-2 py-1 rounded text-gray-500 transition-colors">
                        è¨ªå®¢æ¨¡å¼
                    </div>
                </header>

                <main id="app-content" class="flex-grow p-4 pb-24">
                    <!-- Default Skeleton Loading (è®“ç•«é¢çœ‹èµ·ä¾†ä¸åƒå£æ‰) -->
                    <div class="animate-pulse space-y-4">
                        <div class="h-40 bg-gray-200 rounded-2xl"></div>
                        <div class="grid grid-cols-4 gap-4">
                            <div class="h-16 bg-gray-200 rounded-xl"></div>
                            <div class="h-16 bg-gray-200 rounded-xl"></div>
                            <div class="h-16 bg-gray-200 rounded-xl"></div>
                            <div class="h-16 bg-gray-200 rounded-xl"></div>
                        </div>
                    </div>
                </main>

                <nav class="bg-white border-t border-gray-100 absolute bottom-0 w-full h-16 flex justify-around items-center px-2 z-30">
                    <button onclick="navigateTo('home')" class="nav-item tab-active flex flex-col items-center space-y-1 w-1/4" data-target="home"><span class="text-2xl">ğŸ </span><span class="text-[10px]">é¦–é </span></button>
                    <button onclick="navigateTo('services')" class="nav-item tab-inactive flex flex-col items-center space-y-1 w-1/4" data-target="services"><span class="text-2xl">ğŸ“…</span><span class="text-[10px]">é ç´„</span></button>
                    <button onclick="navigateTo('records')" class="nav-item tab-inactive flex flex-col items-center space-y-1 w-1/4" data-target="records"><span class="text-2xl">ğŸ“‹</span><span class="text-[10px]">ç´€éŒ„</span></button>
                    <button onclick="navigateTo('profile')" class="nav-item tab-inactive flex flex-col items-center space-y-1 w-1/4" data-target="profile"><span class="text-2xl">ğŸ‘¤</span><span class="text-[10px]">æˆ‘çš„</span></button>
                </nav>
            </div>
        </div>

        <!-- Admin Dashboard (Desktop) -->
        <div id="admin-dashboard" class="hidden md:block flex-grow bg-gray-50 overflow-y-auto h-full p-8">
            <h2 class="text-2xl font-bold mb-4">å¾Œå°é è¦½</h2>
            <div class="bg-white p-6 rounded-xl shadow-sm h-64 flex items-center justify-center text-gray-400">
                åœ–è¡¨å€åŸŸ (æ•¸æ“šåŒæ­¥ä¸­...)
            </div>
        </div>
    </div>

    <!-- 3. LIFF SDK æ”¾åœ¨åº•éƒ¨ -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <script>
        // --- è¨­å®šå€ ---
        const LIFF_ID = "2008849711-IGFBS0QP"; // è«‹å¡«å…¥ LIFF ID
        const BACKEND_URL = "https://script.google.com/macros/s/AKfycbzBouzc0G0pe7YdKDs0UWcudD53EebhtZcvHuDmijjVbGmB5ISLr52HfeDWsUTCxvzJ/exec"; // Google Apps Script URL

        // --- è³‡æ–™ç‹€æ…‹ ---
        const store = {
            services: [
                { id: 's1', name: 'ç²¾ç·»å‰ªé«®', price: 600, duration: 60, icon: 'âœ‚ï¸' },
                { id: 's2', name: 'æŸ“é«®è¨­è¨ˆ', price: 2500, duration: 120, icon: 'ğŸ¨' },
                { id: 's3', name: 'é ­çš®è­·ç†', price: 1200, duration: 90, icon: 'ğŸ’†' }
            ],
            staff: [{id:'st1', name:'Alice'}, {id:'st2', name:'Bob'}],
            user: { userId: 'guest', displayName: 'è¨ªå®¢', pictureUrl: '', isLineUser: false },
            bookings: []
        };
        
        let currentState = { view: 'home', booking: {} };

        // --- æ ¸å¿ƒå„ªåŒ–ï¼šéåŒæ­¥åˆå§‹åŒ– ---
        async function startApp() {
            // 1. ç„¡è«– LIFF æ˜¯å¦æº–å‚™å¥½ï¼Œå…ˆæ¸²æŸ“ç•«é¢ (è§£æ±ºç™½ç•«é¢å•é¡Œ)
            renderView('home');

            if (!LIFF_ID) {
                showToast("é–‹ç™¼æ¨¡å¼ (ç„¡ LIFF ID)", false);
                return;
            }

            // 2. è¨­å®š 3ç§’ é€¾æ™‚æ©Ÿåˆ¶
            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error("Timeout")), 3000)
            );

            try {
                // 3. å˜—è©¦é€£ç·š LIFF (èˆ‡é€¾æ™‚ç«¶è³½)
                await Promise.race([liff.init({ liffId: LIFF_ID }), timeoutPromise]);

                // é€£ç·šæˆåŠŸ
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    store.user = {
                        userId: profile.userId,
                        displayName: profile.displayName,
                        pictureUrl: profile.pictureUrl,
                        isLineUser: true
                    };
                    updateUserStatus(true);
                    showToast(`æ­¡è¿å›ä¾†ï¼Œ${profile.displayName}`, false);
                    renderView('home'); // é‡æ–°æ¸²æŸ“ä»¥é¡¯ç¤ºé ­åƒ
                } else {
                    liff.login(); // è‹¥æ²’ç™»å…¥ï¼Œå˜—è©¦ç™»å…¥
                }
            } catch (error) {
                console.warn("LIFF é€£ç·šæ…¢æˆ–å¤±æ•—ï¼Œåˆ‡æ›è‡³è¨ªå®¢æ¨¡å¼", error);
                showToast("ç¶²è·¯è¼ƒæ…¢ï¼Œå·²åˆ‡æ›è‡³è¨ªå®¢æ¨¡å¼", false);
                updateUserStatus(false);
                // å³ä½¿å¤±æ•—ï¼ŒApp ä¾ç„¶å¯ä»¥ä½¿ç”¨ï¼Œä¸æœƒå¡ä½
            }
        }

        // --- UI Helper Functions ---
        function showToast(msg, persist = false) {
            const toast = document.getElementById('liff-toast');
            toast.innerHTML = `<span>${msg}</span>`;
            toast.classList.add('show');
            if (!persist) {
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.classList.add('hidden-toast');
                }, 3000); // 3ç§’å¾Œæ¶ˆå¤±
            }
        }

        function updateUserStatus(isLine) {
            const badge = document.getElementById('user-status-badge');
            if (isLine) {
                badge.innerText = "å·²é€£ç·š LINE";
                badge.className = "text-[10px] bg-green-100 text-green-600 px-2 py-1 rounded transition-colors";
            } else {
                badge.innerText = "è¨ªå®¢æ¨¡å¼";
                badge.className = "text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded transition-colors";
            }
        }

        // --- Navigation Logic ---
        function navigateTo(view) {
            currentState.view = view;
            
            // Update Tabs
            document.querySelectorAll('.nav-item').forEach(el => {
                const target = el.dataset.target;
                if (target === view || (['services','records'].includes(view) && target === view)) {
                     el.classList.add('tab-active');
                     el.classList.remove('tab-inactive');
                } else {
                     el.classList.remove('tab-active');
                     el.classList.add('tab-inactive');
                }
            });

            renderView(view);
        }

        function renderView(view) {
            const content = document.getElementById('app-content');
            content.innerHTML = '';

            if (view === 'home') {
                content.innerHTML = `
                    <div class="space-y-6 animate-fade-in">
                        <div class="w-full h-40 bg-gradient-to-r from-gray-800 to-gray-900 rounded-2xl flex items-center p-6 text-white relative overflow-hidden shadow-lg">
                            <div class="z-10">
                                <h2 class="text-xl font-bold">Hi, ${store.user.displayName}</h2>
                                <p class="text-xs opacity-70 mt-1">${store.user.isLineUser ? 'æœƒå“¡' : 'æ­¡è¿é ç´„'}</p>
                                <button onclick="navigateTo('services')" class="mt-4 bg-[#06C755] text-white px-4 py-2 rounded-full text-sm font-bold shadow-md hover:scale-105 transition-transform">ç«‹å³é ç´„</button>
                            </div>
                            ${store.user.pictureUrl ? `<img src="${store.user.pictureUrl}" class="absolute right-4 bottom-4 w-16 h-16 rounded-full border-2 border-white opacity-80">` : ''}
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div onclick="navigateTo('services')" class="bg-blue-50 p-4 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-blue-100 transition">
                                <span class="text-3xl mb-2">âœ‚ï¸</span><span class="font-bold text-gray-700">ç¾é«®</span>
                            </div>
                            <div onclick="navigateTo('services')" class="bg-pink-50 p-4 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-pink-100 transition">
                                <span class="text-3xl mb-2">ğŸ’…</span><span class="font-bold text-gray-700">ç¾ç”²</span>
                            </div>
                        </div>
                    </div>`;
            } else if (view === 'services') {
                content.innerHTML = `
                    <div class="space-y-3 animate-fade-in">
                        <div class="flex items-center space-x-2 mb-2"><button onclick="navigateTo('home')">â€¹</button><h2 class="font-bold">é¸æ“‡æœå‹™</h2></div>
                        ${store.services.map(s => `
                            <div onclick="alert('é€²å…¥é ç´„æµç¨‹ (æ¨¡æ“¬)')" class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between cursor-pointer hover:border-[#06C755]">
                                <div class="flex items-center space-x-3"><span class="text-2xl">${s.icon}</span><div><div class="font-bold">${s.name}</div><div class="text-xs text-gray-500">${s.duration} åˆ†</div></div></div>
                                <div class="font-bold">NT$ ${s.price}</div>
                            </div>
                        `).join('')}
                    </div>`;
            } else if (view === 'records') {
                content.innerHTML = `<div class="text-center text-gray-400 mt-10">å°šç„¡é ç´„ç´€éŒ„</div>`;
            } else if (view === 'profile') {
                content.innerHTML = `<div class="p-4 bg-white rounded-xl shadow-sm text-center">ID: ${store.user.userId.substring(0,8)}...</div>`;
            }
        }

        // --- Init ---
        // ç¢ºä¿ DOM è¼‰å…¥å¾Œç«‹å³åŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            startApp();
        });

        // ç°¡å–®å‹•ç•«
        const style = document.createElement('style');
        style.innerHTML = `.animate-fade-in { animation: fadeIn 0.4s ease-out forwards; } @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }`;
        document.head.appendChild(style);

    </script>
</body>
</html>